{% load static %}

<style>
    .share-modal .modal-content {
        border-radius: 0.75rem; /* 12px */
        border: none;
    }
    .share-modal .modal-header, .share-modal .modal-footer {
        border: none;
    }
    .share-modal .access-list-item {
        padding: 0.75rem 0;
    }
    .share-modal .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 500;
        background-color: #e9ecef;
        color: #495057;
    }
    .share-modal .accordion-button-sm {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
        background-color: #f8f9fa !important;
        color: #6c757d;
        box-shadow: none !important;
        border-radius: 0.375rem;
    }
    .share-modal .accordion-button-sm::after {
        width: 0.8rem;
        height: 0.8rem;
        background-size: 0.8rem;
    }
    .share-modal .accordion-button-sm:not(.collapsed) {
        font-weight: 600;
        color: #000;
    }
</style>

<div class="modal fade share-modal" id="shareModal-{{ stock.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header pb-0">
                <h4 class="modal-title fw-bold">Compartilhar "{{ stock.name }}"</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                
                <!-- Seção de Convite -->
                <div class="mb-4">
                    <label class="form-label fw-bold small text-uppercase text-muted">Convidar pessoas ou grupos</label>
                    <form action="{% url 'share-stock' stock.id %}" method="post" class="mb-2">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <div class="input-group">
                            <input type="text" name="identifier" class="form-control" placeholder="Email ou nome de usuário" required>
                            <select name="role" class="form-select flex-grow-0" style="width: 150px;">
                                <option value="viewer" selected>Visualizador</option>
                                <option value="editor">Editor</option>
                                <option value="admin">Admin</option>
                            </select>
                            <button type="submit" name="add_member" class="btn btn-primary">Convidar</button>
                        </div>
                    </form>
                    <form method="post" action="{% url 'share-stock' stock.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <div class="input-group">
                            <select class="form-select" name="group_id" required>
                                <option value="" selected disabled>Ou selecione um grupo...</option>
                                {% for group in user.owned_groups.all %}
                                    {% if group not in stock.shared_with_groups.all %}
                                    <option value="{{ group.id }}">{{ group.name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <select class="form-select flex-grow-0" style="width: 150px;" name="role">
                                <option value="viewer">Visualizador</option>
                                <option value="editor">Editor</option>
                                <option value="admin">Admin</option>
                            </select>
                            <button class="btn btn-secondary" type="submit" name="add_group">Adicionar Grupo</button>
                        </div>
                    </form>
                </div>

                <!-- Seção de Acesso -->
                <div>
                    <h6 class="fw-bold small text-uppercase text-muted">Quem tem acesso</h6>
                    <ul class="list-group list-group-flush mt-2">
                        <!-- Dono -->
                        <li class="list-group-item access-list-item d-flex justify-content-between align-items-center px-0">
                            <div class="d-flex align-items-center">
                                <div class="avatar me-3"><i class="bi bi-person-badge-fill fs-5"></i></div>
                                <div>
                                    <div class="fw-bold">{{ stock.owner.username }}</div>
                                    <div class="small text-muted">{{ stock.owner.email }}</div>
                                </div>
                            </div>
                            <span class="text-muted">Proprietário</span>
                        </li>

                        <!-- Outros Acessos -->
                        {% with permissions=stock.get_structured_permissions %}
                            {% for item in permissions %}
                                {% if item.type == 'group' %}
                                    <li class="list-group-item access-list-item px-0">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar me-3"><i class="bi bi-people-fill fs-5"></i></div>
                                                <div>
                                                    <div class="fw-bold">{{ item.group_membership.group.name }}</div>
                                                    <div class="small text-muted">Grupo</div>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center gap-2">
                                                {% if request.user == stock.owner %}
                                                <form action="{% url 'share-stock' stock.id %}" method="post" class="d-inline">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                                    <input type="hidden" name="group_membership_id" value="{{ item.group_membership.id }}">
                                                    <input type="hidden" name="update_group_role" value="true">
                                                    <select name="role" class="form-select form-select-sm" onchange="this.form.submit()">
                                                        <option value="viewer" {% if item.group_membership.role == 'viewer' %}selected{% endif %}>Visualizador</option>
                                                        <option value="editor" {% if item.group_membership.role == 'editor' %}selected{% endif %}>Editor</option>
                                                        <option value="admin" {% if item.group_membership.role == 'admin' %}selected{% endif %}>Admin</option>
                                                    </select>
                                                </form>
                                                <form action="{% url 'share-stock' stock.id %}" method="post" class="d-inline">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                                    <input type="hidden" name="group_membership_id" value="{{ item.group_membership.id }}">
                                                    <button type="submit" name="remove_group" class="btn btn-sm btn-link text-danger" title="Remover"><i class="bi bi-x-lg"></i></button>
                                                </form>
                                                {% else %}
                                                <span class="text-muted">{{ item.group_membership.get_role_display }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <!-- Acordeão de Membros do Grupo com Funcionalidade Completa -->
                                        <div class="accordion accordion-flush" id="accordion-group-{{ item.group_membership.group.id }}">
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button accordion-button-sm collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-group-{{ item.group_membership.group.id }}">
                                                        Ver membros do grupo ({{ item.member_details|length }})
                                                    </button>
                                                </h2>
                                                <div id="collapse-group-{{ item.group_membership.group.id }}" class="accordion-collapse collapse" data-bs-parent="#accordion-group-{{ item.group_membership.group.id }}">
                                                    <div class="accordion-body pt-2 pb-0">
                                                        <ul class="list-group list-group-flush">
                                                            {% for detail in item.member_details %}
                                                                <li class="list-group-item ps-2 py-2">
                                                                    <div>{{ detail.user.username }} <span class="text-muted">({{ detail.user.email }})</span></div>
                                                                    {% if detail.subgroups %}
                                                                    <div class="mt-1 d-flex flex-wrap gap-1">
                                                                        {% for subgroup in detail.subgroups %}
                                                                            <span class="badge bg-secondary fw-normal">{{ subgroup.name }}</span>
                                                                        {% endfor %}
                                                                    </div>
                                                                    {% endif %}
                                                                </li>
                                                            {% empty %}
                                                                <li class="list-group-item ps-2 text-muted small">Este grupo não possui membros.</li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                {% elif item.type == 'user' %}
                                    {% with membership=item.membership %}
                                    <li class="list-group-item access-list-item d-flex justify-content-between align-items-center px-0">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar me-3"><i class="bi bi-person-fill fs-5"></i></div>
                                            <div>
                                                <div class="fw-bold">{{ membership.user.username }}</div>
                                                <div class="small text-muted">{{ membership.user.email }}</div>
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex align-items-center gap-2">
                                            
                                            {% if membership.user == request.user and request.user != stock.owner %}
                                                
                                                <span class="text-muted">{{ membership.get_role_display }}</span>

                                            {% else %}

                                                <form action="{% url 'share-stock' stock.id %}" method="post" class="d-inline">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                                    <input type="hidden" name="member_id" value="{{ membership.user.id }}">
                                                    <input type="hidden" name="update_role" value="true">
                                                    <select name="role" class="form-select form-select-sm" onchange="this.form.submit()">
                                                        <option value="viewer" {% if membership.role == 'viewer' %}selected{% endif %}>Visualizador</option>
                                                        <option value="editor" {% if membership.role == 'editor' %}selected{% endif %}>Editor</option>
                                                        <option value="admin" {% if membership.role == 'admin' %}selected{% endif %}>Admin</option>
                                                    </select>
                                                </form>
                                                <form action="{% url 'share-stock' stock.id %}" method="post" class="d-inline">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                                    <input type="hidden" name="member_id" value="{{ membership.user.id }}">
                                                    <button type="submit" name="remove_member" class="btn btn-sm btn-link text-danger" title="Remover"><i class="bi bi-x-lg"></i></button>
                                                </form>
                                            {% endif %}
                                        </div>
                                    </li>
                                    {% endwith %}
                                {% endif %}
                            {% endfor %}
                        {% endwith %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
        document.addEventListener('DOMContentLoaded', function () {

            document.querySelectorAll('.share-modal').forEach(modal => {
                modal.addEventListener('hidden.bs.modal', function () {
                    const cleanUrl = new URL(window.location);
                    cleanUrl.searchParams.delete('modal');
                    cleanUrl.searchParams.delete('stock_id');
                    window.history.replaceState({}, document.title, cleanUrl);
                });
            });
        });
</script>