<div class="modal fade share-modal" id="shareModal-{{ stock.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable"> <!-- Adicionado modal-dialog-scrollable -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Compartilhar "{{ stock.name }}"</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="share-modal-messages-{{ stock.id }}">
                    {% if request.GET.modal == 'share' and request.GET.stock_id == stock.id|stringformat:"s" %}
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                    {% endif %}
                </div>

                <h6>Convidar novo membro</h6>
                <form action="{% url 'share-stock' stock.id %}" method="post" class="mb-3">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <div class="input-group">
                        <input type="text" name="identifier" class="form-control" placeholder="E-mail ou nome de usuário" required>
                        <select name="role" class="form-select" style="max-width: 150px;">
                            <option value="viewer" selected>Visualizador</option>
                            <option value="editor">Editor</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button type="submit" name="add_member" class="btn btn-dark">Convidar</button>
                    </div>
                </form>
                
                <hr>

                <h6 class="mt-3">Compartilhar com um Grupo</h6>
                <form method="post" action="{% url 'share-stock' stock.id %}" class="mb-3">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <div class="input-group">
                        <select class="form-select" name="group_id" required>
                            <option value="" selected disabled>Selecione um grupo...</option>
                            {% for group in user.owned_groups.all %}
                                {% if group not in stock.shared_with_groups.all %}
                                <option value="{{ group.id }}">{{ group.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <select class="form-select flex-grow-0" style="width: 150px;" name="role">
                            <option value="viewer">Visualizador</option>
                            <option value="editor">Editor</option>
                            <option value="admin">Administrador</option>
                        </select>
                        <button class="btn btn-dark" type="submit" name="add_group">Adicionar Grupo</button>
                    </div>
                </form>

                <hr>
                
                <h6>Acesso Concedido</h6>
                <div class="list-group">
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ stock.owner.username }}</strong>
                            <small class="text-muted">(Dono)</small>
                        </div>
                        <span class="badge bg-dark fs-6">Proprietário</span>
                    </div>

                    {% with permissions=stock.get_structured_permissions %}
                        {% for item in permissions %}
                            

                            {% if item.type == 'group' %}
                            <li class="list-group-item p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-people-fill me-2"></i>
                                        <strong>Grupo: {{ item.group_membership.group.name }}</strong>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <form action="{% url 'share-stock' stock.id %}" method="post" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                            <input type="hidden" name="group_membership_id" value="{{ item.group_membership.id }}">
                                            <input type="hidden" name="update_group_role" value="true">
                                            <select name="role" class="form-select form-select-sm" onchange="this.form.submit()">
                                                <option value="viewer" {% if item.group_membership.role == 'viewer' %}selected{% endif %}>Visualizador</option>
                                                <option value="editor" {% if item.group_membership.role == 'editor' %}selected{% endif %}>Editor</option>
                                                <option value="admin" {% if item.group_membership.role == 'admin' %}selected{% endif %}>Admin</option>
                                            </select>
                                        </form>
                                    </div>
                                </div>
                                <div class="accordion accordion-flush mt-2" id="accordion-group-{{ item.group_membership.group.id }}">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header">
                                            <button class="accordion-button collapsed bg-light py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-group-{{ item.group_membership.group.id }}">
                                                Membros do grupo ({{ item.member_details|length }})
                                            </button>
                                        </h2>
                                        <div id="collapse-group-{{ item.group_membership.group.id }}" class="accordion-collapse collapse" data-bs-parent="#accordion-group-{{ item.group_membership.group.id }}">
                                            <div class="accordion-body p-0">
                                                <ul class="list-group list-group-flush">
                                                    {% for detail in item.member_details %}
                                                    <li class="list-group-item ps-4">
                                                        <div>{{ detail.user.username }} ({{ detail.user.email }})</div>
                                                        {% if detail.subgroups %}
                                                        <div class="mt-1 d-flex flex-wrap gap-1">
                                                            {% for subgroup in detail.subgroups %}
                                                                <span class="badge bg-secondary fw-normal">{{ subgroup.name }}</span>
                                                            {% endfor %}
                                                        </div>
                                                        {% endif %}
                                                    </li>
                                                    {% empty %}
                                                    <li class="list-group-item ps-4 text-muted"><small>Este grupo não possui membros.</small></li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </li>

                            {% elif item.type == 'user' %}
                                {% with membership=item.membership %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ membership.user.username }}</strong>
                                        <small class="text-muted">({{ membership.user.email }})</small>
                                    </div>
                                    <div class="d-flex align-items-center gap-2">
                                        <form action="{% url 'share-stock' stock.id %}" method="post" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                            <input type="hidden" name="member_id" value="{{ membership.user.id }}">
                                            <input type="hidden" name="update_role" value="true">
                                            
                                            <select name="role" class="form-select form-select-sm" onchange="this.form.submit()">
                                                <option value="viewer" {% if membership.role == 'viewer' %}selected{% endif %}>Visualizador</option>
                                                <option value="editor" {% if membership.role == 'editor' %}selected{% endif %}>Editor</option>
                                                <option value="admin" {% if membership.role == 'admin' %}selected{% endif %}>Admin</option>
                                            </select>
                                        </form>
                                        <form action="{% url 'share-stock' stock.id %}" method="post" class="d-inline">
                                            {% csrf_token %}
                                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                                            <input type="hidden" name="member_id" value="{{ membership.user.id }}">
                                            <button type="submit" name="remove_member" class="btn btn-sm btn-outline-danger" title="Remover acesso">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </li>
                                {% endwith %}
                            {% endif %}
                        {% endfor %}

                        {% if not permissions %}
                        <div class="list-group-item text-muted">Este estoque ainda não foi compartilhado.</div>
                        {% endif %}
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>
</div>